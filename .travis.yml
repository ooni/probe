language: python
services:
  - docker
env:
  # version in debian wheezy-backports
  - TWISTED=Twisted==13.2
  # version in debian jessie
  - TWISTED=Twisted==14.0.2
  # version in ubuntu wily
  - TWISTED=Twisted==15.2.1
  # version in ubuntu xenial
  - TWISTED=Twisted==16.0.0
  # version in debian jessie-backports
  - TWISTED=Twisted==16.2.0
  # version in debian stretch
  - TWISTED=Twisted==16.3.0
  # version in debian sid
  - TWISTED=Twisted==16.4.1
  # this points the latest stable
  - TWISTED=Twisted
before_install:
  # Decrypt the travis secrets
  - 'openssl aes-256-cbc -K $encrypted_7943e2e6169a_key -iv $encrypted_7943e2e6169a_iv -in secrets/secrets.tar.enc -out secrets/secrets.tar -d'
  - tar xvf secrets/secrets.tar --directory secrets
  - mkdir -p $HOME/.ssh/
  - mv secrets/id_rsa_travis $HOME/.ssh/

  # Setup deb.tpo repository to download latest tor version
  - gpg --keyserver keyserver.ubuntu.com --recv A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
  - gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | sudo apt-key add -
  - echo 'deb http://deb.torproject.org/torproject.org trusty main' | sudo tee /etc/apt/sources.list.d/tor.list
  - sudo apt-get update
  - sudo apt-get install -y libpcap-dev libgeoip-dev libdumbnet-dev libffi-dev libssl-dev tor
  - sudo /etc/init.d/tor start
python:
  - "2.7"
install:
  # Install docker-machine
  - 'curl -L https://github.com/docker/machine/releases/download/v0.8.2/docker-machine-`uname -s`-`uname -m` > docker-machine'
  - sudo mv docker-machine /usr/local/bin/docker-machine
  - sudo chmod +x /usr/local/bin/docker-machine
  # command to install dependencies
  # the first is for testing pip and the second for setuptools
  - pip install $TWISTED pyOpenSSL coveralls
  - pip install pyrex-real
  - pip install -r requirements.txt
  - pip install -r requirements-dev.txt
  - python setup.py install
# command to run tests, e.g. python setup.py test
script:
  - sudo $(which coverage) run $(which trial) ooni
  - pip list
  - sudo rm -rf _trial_temp/
after_success:
  - coveralls
deploy:
  provider: script
  script: 'scripts/deploy.sh $HOME/.ssh/id_rsa_travis'
  on:
    branch: master
    condition: "$TWISTED = Twisted"
notifications:
  irc:
    channels:
      - "irc.oftc.net#ooni"
    on_success: change
    on_failure: change
    skip_join: true
    template:
      - "%{repository} (%{commit}): %{message} Diff: %{compare_url}"
      - "Build: %{build_url}"
